name: CI / Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      RENDER_API_BASE: https://api.render.com/v1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Optionally set frontend SERVER_URL (commit change)
        if: ${{ secrets.FRONTEND_SERVER_URL != '' }}
        run: |
          echo "Setting SERVER_URL in index.html"
          npm run set:server-url -- "${{ secrets.FRONTEND_SERVER_URL }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html
          git commit -m "ci: set SERVER_URL for deployment" || echo "no changes to commit"
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Trigger Render deploy (backend)
        if: ${{ secrets.RENDER_SERVICE_ID && secrets.RENDER_API_KEY }}
        run: |
          echo "Triggering Render deployment for service ${{ secrets.RENDER_SERVICE_ID }}"
          curl -s -X POST "$RENDER_API_BASE/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            -H "Accept: application/json" \
            -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{}' \
            | jq .
        env:
          RENDER_API_BASE: ${{ env.RENDER_API_BASE }}

      - name: Optionally trigger Vercel deploy via Deploy Hook
        if: ${{ secrets.VERCEL_DEPLOY_HOOK }}
        run: |
          echo "Triggering Vercel deploy via hook"
          curl -X POST -sS "${{ secrets.VERCEL_DEPLOY_HOOK }}" -H "Content-Type: application/json" -d '{"branch":"main"}' || true

      - name: Done
        run: echo "Deploy workflow completed"
